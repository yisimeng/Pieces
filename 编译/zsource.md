# zsource

[原文链接](https://tech.meituan.com/2019/08/08/the-things-behind-the-ios-project-zsource-command.html)

美团iOS工程组件化中的命令。美团使用CocoaPods来进行组件化管理，组件数量过多之后，编译时会重新编译全部组件，浪费时间。因此使用CocoaPods的插件``` cocoapods-binary ``` (非官方插件)，在pod install的时候，就将其他组件编译成二进制。在编译时，只需要编译自己的组件，减少编译时间。

构建时速度增加，调试时无法获得源码那样丰富的调试信息，只知道崩溃到了二进制文件中。

通常的解决方案是提供一个二进制和源码的切换方案，通过命令来切换引入的是源码还是二进制，但是需要重新```pod install```， 又需要浪费时间。

### zsource 可实现的原理

在本地创建两个工程a、b，可在a工程中写一个崩溃，编译出liba.a，b工程中直接导入liba.a，编译运行。

运行到liba.a中的崩溃时，可以查看堆栈信息，在堆栈信息中点击liba.a中崩溃的方法，会自动跳转到源码文件。

b工程中是没有a工程的信息的，但是现在可以打开a的源码文件，只能说明liba.a的静态库中保存了源码文件地址。

通过MachOView查看liba.a，可以发现在对应.o下的 Section (\__DWARF,“__debug_str” )段中，有源码文件的绝对路径，因此ide可以通过查找这个源码路径，直接在项目中打开不属于本工程的源码文件，并且可以实现断点调试。

如果这个修改a工程的路径，则会导致b工程找不到源码，而停留在二进制的崩溃信息中。

### zsource 的实现

1. 在编译时如果遇到崩溃或者在调用二进制库中方法之前打上断点，编译运行。
2. 遇到断点之后，分析lib文件，读取mach-o文件，找到断点的 .o，得到源码路径。
3. 从git上将对应的源码文件，创建一条与mach-o中的绝对路径相同的路径，并存放源码。
4. 点击```step into``` 或者查看崩溃堆栈，点击崩溃方法，IDE会通过liba中的绝对路径查看本地目录，如果有源码，就可以直接打开，并进行调试。

